@startuml
!theme amiga
skinparam componentStyle uml1
skinparam backgroundColor DarkSlateGray

skinparam linetype ortho
skinparam classarrowcolor DarkRed
skinparam SequenceMessageAlign reverseDirection
skinparam actorStyle awesome
skinparam defaultTextAlignment center

title [ARCH]: Notification

frame EventSources << <color:Black>Источники событий</color> >> {
    rectangle UGC << <color:Black>Генерация периодических событий</color> >> #lightslategray
    rectangle "Auth/OAuth2.0" << <color:Black>Генерация автоматических событий</color> >>  as Auth #lightslategray
    component ContentManagerPanel << <color:Black>Панель работы с шаблонами\n<color:Black>сообщений и событиями</color> >>
}
component NotificationAPI << <color:Black>API событий, о которых необходимо\n<color:Black>уведомить пользователя</color> >>
database MongoDB << <color:Black>БД сервиса нотификации</color> >> {
    collections Notifications << <color:Black>События о которых необходимо\n<color:Black>уведомить пользователя c полями\n<color:Black>notification_id, content_id, last_update,\n<color:Black>last_notification_send</color> >>
    collections MessageTemplates << <color:Black>HTML шаблоны сообщений</color> >>
}
queue RabbitMQ << <color:Black>Очереди событий, хранят только id событий</color> >> {
    queue Urgent
    queue Regular
}
node EmailSender << <color:Black>Рассылает на E-mails\n<color:Black>подготовленные уведомления</color> >>
node Worker {
    rectangle EventsGetter << <color:Black>Читает события из очереди</color> >>
    rectangle DataEnricher << <color:Black>Обогащает данными полученное событие</color> >>
    rectangle LetterConstructor << <color:Black>Собирает письмо из шаблонов\n<color:Black>и полученных данных</color> >>
}
actor Users #honeydew
actor Managers #honeydew
component Scheduler << <color:Black>Сканирует БД на наличие новых\n<color:Black>уведомлений, проверяет не были ли\n<color:Black>они отправлены ранее</color> >>
rectangle SearchAPI << <color:Black>Данные о фильмах</color> >> #lightslategray

Auth --|> NotificationAPI
UGC --|> NotificationAPI
NotificationAPI --|> Notifications
Scheduler <|-|> Notifications
Scheduler -|> Urgent
Scheduler --|> Regular
Urgent --|> EventsGetter
Regular --|> EventsGetter
EventsGetter --|> DataEnricher
DataEnricher --|> LetterConstructor
DataEnricher <|-up-|> Auth
DataEnricher -|> SearchAPI
DataEnricher <|---|> Notifications
LetterConstructor --|> EmailSender
LetterConstructor <|-- MessageTemplates
EmailSender --|> Users
EmailSender ---|> Notifications
ContentManagerPanel <|--|> MessageTemplates
Managers <|-up-|> ContentManagerPanel
NotificationAPI <|-- ContentManagerPanel
@endumls
